name: Functional Tests

on:
  push

env:
  FORCE_COLOR: 1

jobs:
  func-tests:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›ï¸  Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          ref: ${{ github.event.pull_request.head.sha }}

      - name: ğŸ§¶  NodeJS setup
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ğŸ”§  Install dependencies
        run: npm i

      - name: âŒ› Create folders
        run: sh ./ci/create-video-directory.sh

      - name: ğŸ—ï¸  Start Selenium Grid
        run: |
          npm run infra:up-mac

      - name: ğŸº  Verify IWG is Running
        run: sh ./ci/wait-for-grid-to-run.sh

      - name: ğŸš€  Run Functional Tests
        run: |
          npm run test:grid-mac

      - name: ğŸŒ‹  Upload Image Diffs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: "image-diffs"
          path: .tmp
          include-hidden-files: true
          retention-days: 5

      - name: ğŸ”ï¸  Upload Functional Test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: "func-tests-report"
          path: reports
          retention-days: 5

      - name: Check videos folder
        if: always()
        run: |
          cd videos
          ls -ll

      - name: ğŸ¥  Upload Videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: "videos"
          path: videos
          include-hidden-files: true
          retention-days: 5
